````markdown
---
description: 在任務生成後，對 spec.md、plan.md 和 tasks.md 進行非破壞性的跨工件一致性和品質分析。
---

## 使用者輸入

```text
$ARGUMENTS
```

在繼續之前，您**必須**考慮使用者輸入（如果不為空）。

## 目標

在實作之前識別三個核心工件（`spec.md`、`plan.md`、`tasks.md`）之間的不一致性、重複、模糊性和規格不足項目。此命令必須僅在 `/speckit.tasks` 成功產生完整的 `tasks.md` 後執行。

## 操作限制

**嚴格唯讀**：**不**修改任何檔案。輸出結構化分析報告。提供可選的補救計劃（使用者必須在手動呼叫任何後續編輯命令之前明確批准）。

**章程權威**：專案章程（`.specify/memory/constitution.md`）在此分析範圍內是**不可協商的**。章程衝突自動為關鍵，需要調整規格、計劃或任務——而不是稀釋、重新詮釋或默默忽略原則。如果原則本身需要更改，那必須在 `/speckit.analyze` 之外的單獨、明確的章程更新中發生。

## 執行步驟

### 1. 初始化分析背景

從儲存庫根目錄執行一次 `.specify/scripts/bash/check-prerequisites.sh --json --require-tasks --include-tasks` 並解析 JSON 以獲取 FEATURE_DIR 和 AVAILABLE_DOCS。派生絕對路徑：

- SPEC = FEATURE_DIR/spec.md
- PLAN = FEATURE_DIR/plan.md
- TASKS = FEATURE_DIR/tasks.md

如果缺少任何必需的檔案，則中止並顯示錯誤訊息（指示使用者執行缺少的先決條件命令）。
對於參數中的單引號（如 "I'm Groot"），使用轉義語法：例如 'I'\''m Groot'（或盡可能使用雙引號："I'm Groot"）。

### 2. 載入工件（漸進式揭露）

僅從每個工件載入最少必要的背景：

**從 spec.md：**

- 概述/背景
- 功能需求
- 非功能需求
- 使用者故事
- 邊界情況（如果存在）

**從 plan.md：**

- 架構/堆疊選擇
- 資料模型參考
- 階段
- 技術限制

**從 tasks.md：**

- 任務 ID
- 描述
- 階段分組
- 並行標記 [P]
- 參考的檔案路徑

**從章程：**

- 載入 `.specify/memory/constitution.md` 以進行原則驗證

### 3. 建立語意模型

建立內部表示（不要在輸出中包含原始工件）：

- **需求清單**：每個功能 + 非功能需求都有一個穩定的鍵（基於祈使短語派生 slug；例如「使用者可以上傳檔案」→ `user-can-upload-file`）
- **使用者故事/動作清單**：具有驗收標準的離散使用者動作
- **任務覆蓋映射**：將每個任務映射到一個或多個需求或故事（透過關鍵字 / 明確的參考模式（如 ID 或關鍵短語）推斷）
- **章程規則集**：提取原則名稱和必須/應該規範性陳述

### 4. 偵測通過（令牌高效分析）

專注於高信號發現。限制總共 50 個發現；在溢出摘要中聚合其餘部分。

#### A. 重複偵測

- 識別近重複需求
- 標記較低品質的措辭以進行整合

#### B. 模糊性偵測

- 標記模糊的形容詞（快速、可擴展、安全、直觀、健壯）缺乏可衡量的標準
- 標記未解決的佔位符（TODO、TKTK、???、`<placeholder>` 等）

#### C. 規格不足

- 具有動詞但缺少對象或可衡量結果的需求
- 缺少驗收標準對齊的使用者故事
- 參考規格/計劃中未定義的檔案或元件的任務

#### D. 章程對齊

- 任何與必須原則衝突的需求或計劃元素
- 章程中缺少強制部分或品質閘門

#### E. 覆蓋差距

- 零相關任務的需求
- 沒有映射需求/故事的任務
- 未反映在任務中的非功能需求（例如效能、安全性）

#### F. 不一致性

- 術語漂移（跨檔案以不同方式命名相同概念）
- 計劃中參考但規格中缺少的資料實體（或反之亦然）
- 任務排序矛盾（例如整合任務在基礎設定任務之前，沒有依賴關係註釋）
- 衝突的需求（例如一個需要 Next.js，另一個指定 Vue）

### 5. 嚴重性分配

使用此啟發式方法對發現進行優先排序：

- **關鍵**：違反章程必須、缺少核心規格工件或零覆蓋的需求阻止基線功能
- **高**：重複或衝突的需求、模糊的安全性/效能屬性、不可測試的驗收標準
- **中**：術語漂移、缺少非功能任務覆蓋、規格不足的邊界情況
- **低**：樣式/措辭改進、不影響執行順序的次要冗餘

### 6. 產生緊湊的分析報告

輸出 Markdown 報告（不寫入檔案），具有以下結構：

## 規格分析報告

| ID | 類別 | 嚴重性 | 位置 | 摘要 | 建議 |
|----|------|--------|------|------|------|
| A1 | 重複 | 高 | spec.md:L120-134 | 兩個相似的需求 ... | 合併措辭；保留更清楚的版本 |

（每個發現添加一行；生成以類別首字母為前綴的穩定 ID。）

**覆蓋摘要表：**

| 需求鍵 | 有任務？ | 任務 ID | 註釋 |
|--------|----------|---------|------|

**章程對齊問題：**（如果有）

**未映射的任務：**（如果有）

**指標：**

- 總需求數
- 總任務數
- 覆蓋率 %（具有 >=1 個任務的需求）
- 模糊性計數
- 重複計數
- 關鍵問題計數

### 7. 提供下一步動作

在報告結尾，輸出簡潔的下一步動作區塊：

- 如果存在關鍵問題：建議在 `/speckit.implement` 之前解決
- 如果僅低/中：使用者可以繼續，但提供改進建議
- 提供明確的命令建議：例如「使用改進執行 /speckit.specify」、「執行 /speckit.plan 以調整架構」、「手動編輯 tasks.md 以添加 'performance-metrics' 的覆蓋」

### 8. 提供補救

詢問使用者：「您希望我為前 N 個問題建議具體的補救編輯嗎？」（不要自動應用它們。）

## 操作原則

### 背景效率

- **最少的高信號令牌**：專注於可操作的發現，而不是詳盡的文件
- **漸進式揭露**：逐步載入工件；不要將所有內容傾倒到分析中
- **令牌高效輸出**：將發現表限制為 50 行；總結溢出
- **確定性結果**：在沒有更改的情況下重新執行應產生一致的 ID 和計數

### 分析指南

- **永不修改檔案**（這是唯讀分析）
- **永不幻想缺少的部分**（如果缺少，請準確報告）
- **優先處理章程違規**（這些總是關鍵）
- **使用範例而不是詳盡的規則**（引用特定實例，而不是通用模式）
- **優雅地報告零問題**（發出包含覆蓋統計資訊的成功報告）

## 背景

$ARGUMENTS

````
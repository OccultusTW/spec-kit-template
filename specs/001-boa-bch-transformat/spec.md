# 功能規格書：BOA 批次轉檔服務

**功能分支**：`001-boa-bch-transformat`  
**建立日期**：2025-11-30  
**狀態**：草稿  
**輸入**：使用者描述：「讀取 txt 檔案並轉換成 parquet 格式，支援多種編碼與資料格式，處理完成後呼叫遮罩轉換服務」

**參考架構**：`./memory/references-docs/pre-architecture.md`

## 使用者情境與測試 *(必填)*

### 使用者故事 1 - 基本檔案讀取與格式轉換 (優先級：P1)

系統管理者需要將儲存在 NAS 上的文字檔案轉換為 parquet 格式，以便後續進行資料分析與處理。這些文字檔案可能使用不同的編碼格式（big5 或 utf-8），並且資料可能以分隔符號或固定長度方式儲存。

**為什麼是這個優先級**：這是核心功能，沒有檔案讀取與格式轉換，整個服務就無法運作。此功能提供最基本的價值 - 將原始資料轉換為可用的格式。

**獨立測試**：可以透過準備測試用的 txt 檔案（包含不同編碼與格式），執行轉換流程，驗證產出的 parquet 檔案內容是否正確，無需依賴後續的遮罩或轉換服務。

**驗收情境**：

1. **假設** 資料庫中有一筆待處理的檔案記錄，檔案使用 big5 編碼且以 `||` 分隔，**當** 批次服務讀取該檔案並進行轉換，**則** 成功產生對應的 parquet 檔案，且資料內容與原始檔案一致
2. **假設** 資料庫中有一筆待處理的檔案記錄，檔案使用 utf-8 編碼且以 `@!!@` 分隔，**當** 批次服務讀取該檔案並進行轉換，**則** 成功產生對應的 parquet 檔案，且資料內容正確解析
3. **假設** 資料庫中有一筆待處理的檔案記錄，檔案使用固定長度格式且編碼為 big5，**當** 批次服務讀取該檔案並進行轉換，**則** 成功依據欄位長度定義解析資料，並產生正確的 parquet 檔案
4. **假設** 資料庫中有一筆待處理的檔案記錄，檔案使用固定長度格式且資料值包含前後空白，**當** 批次服務讀取該檔案並進行轉換，**則** 系統自動去除每個欄位的前後空白，產生整潔的 parquet 檔案

---

### 使用者故事 2 - 多檔案批次處理與並行控制 (優先級：P1)

當有多個檔案需要處理且系統部署多個 pod 時，系統管理者需要確保每個檔案只被處理一次，避免重複轉換造成資源浪費或資料不一致。

**為什麼是這個優先級**：在 Kubernetes 多 pod 環境下，並行控制是必須的核心功能。沒有這個機制，系統將無法正確運作，會產生嚴重的資料處理問題。

**獨立測試**：可以透過在資料庫中建立多筆待處理檔案記錄，模擬多個 pod 同時執行的情境，驗證每個檔案是否只被一個 pod 處理，無需等待後續的遮罩服務完成。

**驗收情境**：

1. **假設** 資料庫中有 10 筆待處理的檔案記錄，且有 4 個 pod 同時運行，**當** 批次服務啟動並讀取待處理檔案清單，**則** 每個檔案都能被成功鎖定並由單一 pod 處理，不會出現重複處理
2. **假設** Pod A 正在處理檔案 X 並持有資料庫鎖定，**當** Pod B 嘗試處理相同的檔案 X，**則** Pod B 無法取得該檔案的鎖定，會跳過該檔案並處理下一個可用的檔案
3. **假設** Pod A 在處理檔案時發生異常中斷（pod 重啟或當機），**當** 鎖定逾時後，**則** 其他 pod 能夠重新取得該檔案的鎖定並繼續處理
4. **假設** 資料庫中有 5 筆待處理檔案，且只有 1 個 pod 運行，**當** 批次服務逐一處理檔案，**則** 所有檔案都能按順序正確處理完成

---

### 使用者故事 3 - 呼叫遮罩轉換服務與重試機制 (優先級：P2)

當檔案成功轉換為 parquet 格式後，系統需要呼叫下游的遮罩轉換服務進行進一步處理。由於網路或服務可能暫時不可用，系統需要具備重試能力以提高整體可靠性。

**為什麼是這個優先級**：呼叫下游服務是完整流程的一部分，但不影響核心的檔案轉換功能。即使下游服務暫時不可用，檔案轉換本身已經完成並提供價值。重試機制提升可靠性但非立即必要。

**獨立測試**：可以透過模擬下游服務的各種回應（成功、暫時失敗、持續失敗），驗證重試機制是否正確運作，以及最終的處理狀態是否正確記錄。

**驗收情境**：

1. **假設** 檔案已成功轉換為 parquet 格式，且下游遮罩轉換服務正常運作，**當** 批次服務呼叫下游服務，**則** 下游服務成功接收請求並回應成功，檔案狀態更新為已完成
2. **假設** 檔案已成功轉換為 parquet 格式，但第一次呼叫下游服務時發生暫時性錯誤（如網路逾時），**當** 批次服務執行重試，**則** 系統自動重試最多 3 次，若其中一次成功則完成處理
3. **假設** 檔案已成功轉換為 parquet 格式，但下游服務持續無法回應（重試 3 次皆失敗），**當** 所有重試都失敗後，**則** 系統將檔案標記為處理失敗，並記錄詳細的錯誤資訊供後續追蹤
4. **假設** 檔案已成功轉換為 parquet 格式，呼叫下游服務的過程中網路連線中斷，**當** 重試機制啟動，**則** 系統在重試間隔後重新嘗試呼叫，直到成功或達到最大重試次數

---

### 使用者故事 4 - 資料類型處理與欄位轉碼標記 (優先級：P3)

為了支援後續的資料處理流程，系統需要正確識別並處理不同的資料類型（字串、整數、浮點數、時間戳記），並為每個欄位標記轉碼型態，以便下游服務進行遮罩或轉換。

**為什麼是這個優先級**：資料類型處理提升資料品質與後續處理的準確性，但基本的字串處理已能滿足初期需求。轉碼型態標記主要服務於下游系統，對核心轉換功能的影響較小。

**獨立測試**：可以透過準備包含各種資料類型的測試檔案，驗證每個欄位的資料類型是否正確識別與轉換，以及轉碼型態標記是否正確設定。

**驗收情境**：

1. **假設** 檔案的欄位定義中包含字串、整數、浮點數、時間戳記等不同類型，**當** 批次服務讀取並解析資料，**則** 每個欄位都依據其定義的類型正確轉換並儲存至 parquet 檔案
2. **假設** 檔案的欄位定義中包含時間戳記類型，且原始資料為特定格式的日期時間字串，**當** 批次服務進行資料轉換，**則** 系統正確解析時間戳記並轉換為標準格式儲存
3. **假設** 檔案的欄位定義中某個欄位需要進行遮罩處理，**當** 系統讀取該欄位的轉碼型態設定，**則** 轉碼型態資訊正確記錄並可供下游服務使用
4. **假設** 檔案中某個數值欄位包含非數值內容，**當** 批次服務嘗試轉換該欄位，**則** 系統識別資料類型不符，記錄錯誤並拋出異常以便監控系統捕捉

---

### 邊界情況

- **檔案不存在或無法讀取**：當資料庫記錄指向的檔案在 NAS 上不存在或無法透過 SFTP 讀取時，系統記錄錯誤並將該檔案標記為處理失敗，拋出異常供 Graylog 捕捉進行告警。
- **編碼偵測失敗**：當檔案的實際編碼與資料庫記錄的編碼不符，或系統無法正確偵測編碼時，系統記錄編碼錯誤詳情，將檔案標記為處理失敗，並拋出異常。
- **資料格式不符預期**：當檔案內容與欄位定義不一致（如分隔符號錯誤、固定長度不符、欄位數量不符），系統記錄資料解析錯誤，將檔案標記為處理失敗，並拋出異常。
- **資料庫連線中斷**：當系統與資料庫的連線中斷時，無法取得檔案清單或更新處理狀態，系統記錄資料庫連線錯誤，停止處理並拋出異常，等待連線恢復後重新執行。
- **SFTP 連線中斷**：當系統與 NAS 的 SFTP 連線中斷時，無法讀取檔案內容，系統記錄 SFTP 連線錯誤，將該次處理標記為失敗，並拋出異常。
- **磁碟空間不足**：當系統暫存空間不足以儲存轉換過程中的暫存檔案時，系統記錄磁碟空間不足錯誤，停止處理該檔案並拋出異常。
- **parquet 檔案寫入失敗**：當系統無法將轉換後的資料寫入 parquet 檔案時，系統記錄寫入錯誤詳情，將檔案標記為處理失敗，並拋出異常。
- **advisory lock 取得逾時**：當系統無法在合理時間內取得資料庫的 advisory lock 時（表示該檔案被其他 pod 長時間佔用或發生異常），系統跳過該檔案並處理下一個可用檔案。
- **下游服務完全無法連線**：當下游遮罩轉換服務的網路位址無法解析或完全無法連線時，系統在 3 次重試後標記為失敗，記錄詳細錯誤資訊並拋出異常。
- **超大檔案處理**：當檔案大小超過 1GB 時，系統需要確保記憶體使用不超過配置的 2GB 限制，採用串流方式處理，避免一次性載入整個檔案。
- **空白檔案或無資料內容**：當檔案存在但內容為空白時，系統記錄警告訊息，產生空白的 parquet 檔案（僅包含欄位定義），將檔案標記為已完成但註記無資料內容。

## 需求 *(必填)*

### 功能需求

#### 檔案讀取與解析

- **FR-001**：系統必須從資料庫讀取所有待處理的檔案清單，每筆記錄包含檔案位置、編碼類型、資料格式、欄位定義、轉碼型態等資訊
- **FR-002**：系統必須透過 SFTP 協定連線至 NAS，讀取指定路徑的文字檔案內容
- **FR-003**：系統必須支援 big5 與 utf-8 兩種編碼格式的檔案讀取，依據資料庫記錄的編碼類型進行正確解碼
- **FR-004**：系統必須支援分隔符號格式的資料解析，分隔符號包含但不限於 `||`、`@!!@` 等自訂符號
- **FR-005**：系統必須支援固定長度格式的資料解析，依據欄位定義的長度擷取對應的資料內容
- **FR-006**：系統必須在解析固定長度資料時，自動去除每個欄位值的前後空白字元
- **FR-007**：系統必須在處理固定長度資料時，考慮編碼類型對字元長度的影響，確保正確擷取資料（如 big5 的中文字元佔 2 bytes）

#### 資料轉換與類型處理

- **FR-008**：系統必須將解析後的資料轉換為 parquet 格式並儲存
- **FR-009**：系統必須支援字串（String）、整數（int）、浮點數（double）、時間戳記（timestamp）等資料類型的轉換
- **FR-010**：系統必須依據欄位定義的資料類型，將原始文字資料轉換為對應的類型並儲存至 parquet 檔案
- **FR-011**：系統必須為每個欄位記錄轉碼型態標記，供下游服務進行遮罩或轉換使用
- **FR-012**：系統必須在 parquet 檔案的 metadata 或對應的資料結構中，儲存欄位名稱、資料類型、轉碼型態等資訊

#### 規格判斷與資料篩選

- **FR-013**：系統必須透過資料庫中的規格識別欄位，判斷該檔案是否屬於此批次轉檔服務應處理的範圍
- **FR-014**：系統必須在讀取待處理檔案清單時，只篩選出屬於此規格的檔案進行處理，忽略其他規格的檔案

#### 下游服務呼叫與重試機制

- **FR-015**：系統必須在完成 parquet 檔案轉換後，呼叫下游的遮罩轉換服務進行後續處理
- **FR-016**：系統必須在呼叫下游服務失敗時，自動執行重試機制，最多重試 3 次
- **FR-017**：系統必須在重試 3 次後仍然失敗時，將檔案標記為處理失敗狀態，並記錄詳細的失敗原因

#### 並行控制與狀態管理

- **FR-018**：系統必須使用 PostgreSQL 的 advisory lock 機制，確保在多 pod 環境下每個檔案只被一個 pod 處理
- **FR-019**：系統必須在開始處理檔案前，嘗試取得該檔案對應的 advisory lock
- **FR-020**：系統必須在無法取得 advisory lock 時，跳過該檔案並處理下一個可用的檔案
- **FR-021**：系統必須在完成檔案處理後（無論成功或失敗），釋放對應的 advisory lock
- **FR-022**：系統必須在資料庫中更新檔案的處理狀態，包含：待處理、處理中、已完成、處理失敗等狀態
- **FR-023**：系統必須記錄每個檔案的處理開始時間、完成時間、處理結果、錯誤訊息等詳細資訊

#### 錯誤處理與告警

- **FR-024**：系統必須在發生任何處理異常時，將錯誤資訊拋出並記錄至日誌系統，以便 Graylog 捕捉並進行告警
- **FR-025**：系統必須在錯誤訊息中包含足夠的上下文資訊，包含檔案名稱、處理階段、具體錯誤原因等
- **FR-026**：系統必須使用繁體中文撰寫錯誤訊息，清楚描述問題發生的原因與可能的解決方向
- **FR-027**：系統必須在檔案讀取失敗、資料解析錯誤、格式轉換失敗、下游服務呼叫失敗等情境下，都能正確拋出異常並記錄

### 關鍵實體

- **檔案記錄（File Record）**：代表一筆需要處理的檔案資訊，包含檔案路徑、檔案名稱、編碼類型（big5/utf-8）、資料格式類型（分隔符號/固定長度）、分隔符號內容或欄位長度定義、欄位名稱清單、欄位資料類型清單、欄位轉碼型態清單、規格識別碼、處理狀態、處理開始時間、處理完成時間、錯誤訊息等屬性
- **欄位定義（Field Definition）**：代表檔案中每個欄位的詳細定義，包含欄位名稱、欄位順序、資料類型（String/int/double/timestamp）、欄位長度（固定長度格式時使用）、轉碼型態標記等屬性
- **處理狀態（Processing Status）**：代表檔案當前的處理狀態，包含待處理、處理中、已完成、處理失敗等狀態值，以及狀態變更時間與相關訊息
- **Advisory Lock 識別碼**：代表用於並行控制的鎖定識別碼，通常基於檔案的唯一識別碼生成，用於確保單一檔案只被一個 pod 處理

## 成功標準 *(必填)*

### 可衡量的成果

- **SC-001**：系統能夠正確處理 big5 與 utf-8 編碼的文字檔案，轉換後的 parquet 檔案內容與原始檔案完全一致，資料正確率達 100%
- **SC-002**：系統能夠在多 pod 環境下（4 個 pod）正確處理大量檔案，每個檔案只被處理一次，無重複處理情況，正確率達 100%
- **SC-003**：系統能夠處理大型檔案（大於 1GB），記憶體使用量不超過配置的 2GB 限制，避免 pod 因記憶體不足而重啟
- **SC-004**：系統的下游服務呼叫成功率在網路正常情況下達 95% 以上，透過重試機制提升整體可靠性
- **SC-005**：系統在發生錯誤時，能在 1 分鐘內將錯誤訊息記錄至日誌系統，並觸發 Graylog 告警，讓維運團隊及時發現並處理問題
- **SC-006**：系統能夠在合理時間內完成檔案處理，單一檔案（1GB）的處理時間不超過 10 分鐘，確保批次處理效率
- **SC-007**：系統的錯誤訊息清晰明確，維運團隊能夠根據錯誤訊息在 80% 的情況下快速定位問題原因，減少故障排除時間
